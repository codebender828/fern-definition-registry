# yaml-language-server: $schema=https://raw.githubusercontent.com/fern-api/fern/main/fern.schema.json

imports:
  validation: validation.yml

ids:
  - GeneratorTaskId

types:
  ############
  # Artifact #
  ############

  ApiName: string
  ApiVersion: string
  EnvironmentName: string

  ApiArtifact:
    properties:
      name: ApiName
      version: ApiVersion
      createdAt: datetime
      info: ApiArtifactInfo
  
  ApiArtifactInfo: 
    union: 
      invalid: InvalidApiArtifact
      valid: ValidApiArtifact
  
  InvalidApiArtifact: 
    properties: 
      warnings: list<validation.ValidationWarning> 
      errors: list<validation.ValidationError>
  
  ValidApiArtifact: 
    properties:
      warnings: list<validation.ValidationWarning> 
      draftInfo: DraftInfo
      releaseInfo: optional<ReleaseInfo>
      deployments: map<EnvironmentName, DeploymentInfo>

  DraftInfo:
    properties:
      taskIds: list<GeneratorTaskId>
      promotion: optional<PromotionInfo>

  PromotionInfo:
    properties:
      promotedAt: datetime
      commit: optional<GithubCommit>

  GithubCommit:
    properties:
      organization: OrganizationName
      repoId: string
      commitHash: string

  ReleaseInfo:
    properties:
      releasedAt: datetime
      taskIds: list<GeneratorTaskId>

  DeploymentInfo:
    properties:
      deployedAt: datetime

  ##############
  # Generation #
  ##############

  OrganizationName: string
  GeneratorName: string
  GeneratorVersion: string

  #####
  # Draft
  #####

  DraftRequest:
    properties:
      organization: OrganizationName
      apiName: ApiName
      generators: list<DraftGeneratorConfig>
      apiDefinition: RawApiDefinition

  DraftResponse:
    properties:
      apiVersion: ApiVersion
      taskIds: list<GeneratorTaskId>

  DraftGeneratorConfig:
    properties:
      generatorName: GeneratorName
      generatorVersion: GeneratorVersion
      customConfig: unknown
      outputLocation: OutputLocation

  OutputLocation:
    union:
      registry: RegistryOutput
      local: void
  
  RegistryOutput:
    properties: 
      customRegistry:
        type: optional<RegistryConfig>
        docs: If not provided, artifacts will be published to Fern managed registries.

  RawApiDefinition:
    properties:
      files: list<File>

  File:
    properties:
      relativePath: string
      contents: string

  #####
  # Promote
  #####

  PromoteRequest:
    properties:
      organization: OrganizationName
      apiName: ApiName
      version: ApiVersion

  #####
  # Release
  #####

  ReleaseRequest:
    properties:
      organization: OrganizationName
      apiName: ApiName
      version: ApiVersion
      generators: list<ReleaseGeneratorConfig>

  ReleaseResponse:
    properties:
      taskIds: list<GeneratorTaskId>

  ReleaseGeneratorConfig:
    properties:
      generatorName: GeneratorName
      generatorVersion: GeneratorVersion
      customConfig: unknown
      customRegistry:
        type: optional<RegistryConfig>
        docs: If not provided, artifacts will be published to Fern managed registries.

  RegistryConfig:
    union:
      npm: NpmRegistryConfig
      maven: MavenRegistryConfig

  NpmRegistryConfig:
    properties:
      registryUrl: string
      auth: optional<RegistryAuth>
      scope: string

  MavenRegistryConfig:
    properties:
      registryUrl: string
      auth: optional<RegistryAuth>
      group: string

  RegistryAuth:
    properties:
      username: string
      password: string

  #####
  # Versions
  #####

  GetVersionsRequest:
    properties:
      organization: OrganizationName
      apiName: ApiName
      includeDrafts:
        type: optional<boolean>
        docs: Defaults to false
      pageToken: 
        type: optional<ApiVersion>
        docs: If specified, will paginate from this version onwards.

  ApiVersionsPage:
    properties:
      apis: list<ApiArtifact>
      nextPageToken:
        type: optional<ApiVersion>
        docs: If present, another page of API versions exists.

services:
  http:
    DefinitionRegistryService:
      auth: none
      base-path: /registry
      endpoints:
        draft:
          request: DraftRequest
          response: DraftResponse
          errors:
            - InvalidApiDefinitionError
            - OrganizationDoesNotExistError

        promote:
          request: PromoteRequest
          errors:
            - OrganizationDoesNotExistError
            - ApiDoesNotExistError
            - ApiVersionDoesNotExistError
            - ApiVersionIsAlreadyPromotedError

        release:
          request: ReleaseRequest
          response: ReleaseResponse
          errors:
            - OrganizationDoesNotExistError
            - ApiDoesNotExistError
            - ApiVersionDoesNotExistError
            - ApiVersionIsAlreadyReleasedError

        getVersions:
          request: GetVersionsRequest
          response: ApiVersionsPage
          errors:
            - OrganizationDoesNotExistError
            - ApiDoesNotExistError

errors:
  OrganizationDoesNotExistError:
    http:
      statusCode: 404
  ApiDoesNotExistError:
    http:
      statusCode: 404
  ApiVersionDoesNotExistError:
    http:
      statusCode: 404
  ApiVersionIsAlreadyPromotedError:
    http:
      statusCode: 400
  ApiVersionIsAlreadyReleasedError:
    http:
      statusCode: 400
  InvalidApiDefinitionError: 
    http: 
      statusCode: 400
    type: 
      properties: 
        warnings: list<validation.ValidationWarning> 
        errors: list<validation.ValidationError>
